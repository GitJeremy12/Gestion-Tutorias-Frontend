<div class="history-container">
  <!-- Header con botÃ³n de exportar -->
  <div class="history-header">
    <div class="header-content">
      <div>
        <h2>Mi Historial de TutorÃ­as</h2>
        <p class="subtitle">Revisa todas tus tutorÃ­as anteriores</p>
      </div>
      <button class="btn-export" (click)="exportarHistorial()" *ngIf="tutoriasFiltradas.length > 0 && !loading">
        <span>ğŸ“¥</span>
        Exportar CSV
      </button>
    </div>
  </div>

  <!-- Estado de carga -->
  <div class="loading-state" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando historial...</p>
  </div>

  <!-- Contenido principal (solo si no estÃ¡ cargando) -->
  <div *ngIf="!loading">
    <!-- Filtros y estadÃ­sticas -->
    <div class="filters-section">
      <div class="filter-group">
        <label for="materiaFiltro">
          <span class="filter-icon">ğŸ”</span>
          Filtrar por materia
        </label>
        <select
          [(ngModel)]="materiaFiltro"
          id="materiaFiltro"
          (change)="filtrarPorMateria()">
          <option value="">Todas las materias</option>
          <option *ngFor="let m of materias" [value]="m">{{ m }}</option>
        </select>
        <button class="btn-clear-filter" *ngIf="materiaFiltro" (click)="limpiarFiltros()">
          <span>âœ•</span> Limpiar filtro
        </button>
      </div>

      <!-- EstadÃ­sticas -->
      <div class="stats-cards">
        <div class="stat-card">
          <span class="stat-icon">ğŸ“š</span>
          <div class="stat-info">
            <span class="stat-value">{{ tutoriasFiltradas.length }}</span>
            <span class="stat-label">TutorÃ­as</span>
          </div>
        </div>
        <div class="stat-card">
          <span class="stat-icon">ğŸ“–</span>
          <div class="stat-info">
            <span class="stat-value">{{ materias.length }}</span>
            <span class="stat-label">Materias</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje de error -->
    <div class="error-message" *ngIf="error">
      <span class="error-icon">âš ï¸</span>
      {{ error }}
    </div>

    <!-- Tabla de tutorÃ­as -->
    <div class="table-container">
      <div class="table-wrapper" *ngIf="tutoriasFiltradas.length > 0; else noTutorias">
        <table class="tutorias-table">
          <thead>
            <tr>
              <th>Fecha y Hora</th>
              <th>Materia</th>
              <th>Tema</th>
              <th>Tutor</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of tutoriasFiltradas; let i = index"
                [class.row-even]="i % 2 === 0"
                class="table-row">
              <td data-label="Fecha y Hora">
                <div class="date-cell">
                  <span class="date-icon">ğŸ“…</span>
                  <div class="date-info">
                    <span class="date-day">{{ t.fechaHora | date:'dd/MM/yyyy' }}</span>
                    <span class="date-time">{{ t.fechaHora | date:'HH:mm' }}</span>
                  </div>
                </div>
              </td>
              <td data-label="Materia">
                <span class="materia-badge">{{ t.materia }}</span>
              </td>
              <td data-label="Tema">
                <span class="tema-text">{{ t.tema }}</span>
              </td>
              <td data-label="Tutor">
                <div class="tutor-cell">
                  <span class="tutor-icon">ğŸ‘¨â€ğŸ«</span>
                  <span class="tutor-name">{{ t.tutor?.nombre || 'N/A' }}</span>
                </div>
              </td>
              <td data-label="Estado">
                <span class="status-badge" [ngClass]="getStatusClass(t)">
                  {{ getStatusText(t) }}
                </span>
              </td>
              <td data-label="Acciones">
                <button class="btn-detail" (click)="verDetalle(t)">
                  <span class="btn-icon">ğŸ‘ï¸</span>
                  Ver detalle
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mensaje cuando no hay tutorÃ­as -->
      <ng-template #noTutorias>
        <div class="empty-state">
          <div class="empty-icon">ğŸ“š</div>
          <h3>No hay tutorÃ­as registradas</h3>
          <p *ngIf="materiaFiltro">No se encontraron tutorÃ­as para la materia "{{ materiaFiltro }}"</p>
          <p *ngIf="!materiaFiltro">AÃºn no has agendado ninguna tutorÃ­a</p>
          <button class="btn-primary" routerLink="/agendar">
            Agendar mi primera tutorÃ­a
          </button>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Modal de detalle -->
  <div class="modal-overlay" *ngIf="seleccionada" (click)="cerrarDetalle()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle de TutorÃ­a</h3>
        <button class="btn-close" (click)="cerrarDetalle()" aria-label="Cerrar">
          <span>âœ•</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Estado destacado -->
        <div class="detail-section">
          <div class="status-display">
            <span class="status-badge large" [ngClass]="getStatusClass(seleccionada)">
              {{ getStatusText(seleccionada) }}
            </span>
          </div>
        </div>

        <!-- InformaciÃ³n General -->
        <div class="detail-section">
          <h4>InformaciÃ³n General</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-icon">ğŸ‘¨â€ğŸ“</span>
              <div class="detail-content">
                <span class="detail-label">Estudiante</span>
                <span class="detail-value">{{ seleccionada.estudiante?.nombre || 'No disponible' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">ğŸ‘¨â€ğŸ«</span>
              <div class="detail-content">
                <span class="detail-label">Tutor</span>
                <span class="detail-value">{{ seleccionada.tutor?.nombre || 'No disponible' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">ğŸ“…</span>
              <div class="detail-content">
                <span class="detail-label">Fecha</span>
                <span class="detail-value">{{ seleccionada.fechaHora | date:'fullDate':'':'es-ES' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">ğŸ•</span>
              <div class="detail-content">
                <span class="detail-label">Hora</span>
                <span class="detail-value">{{ seleccionada.fechaHora | date:'HH:mm' }}</span>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">â±ï¸</span>
              <div class="detail-content">
                <span class="detail-label">DuraciÃ³n</span>
                <span class="detail-value">{{ formatearDuracion(seleccionada.duracion) }}</span>
              </div>
            </div>

            <div class="detail-item" *ngIf="seleccionada.tutor?.especialidad">
              <span class="detail-icon">ğŸ“</span>
              <div class="detail-content">
                <span class="detail-label">Especialidad</span>
                <span class="detail-value">{{ seleccionada.tutor.especialidad }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Detalles AcadÃ©micos -->
        <div class="detail-section">
          <h4>Detalles AcadÃ©micos</h4>
          <div class="detail-grid">
            <div class="detail-item full-width">
              <span class="detail-icon">ğŸ“š</span>
              <div class="detail-content">
                <span class="detail-label">Materia</span>
                <span class="detail-value">{{ seleccionada.materia }}</span>
              </div>
            </div>

            <div class="detail-item full-width">
              <span class="detail-icon">ğŸ“–</span>
              <div class="detail-content">
                <span class="detail-label">Tema</span>
                <span class="detail-value">{{ seleccionada.tema }}</span>
              </div>
            </div>

            <div class="detail-item full-width" *ngIf="seleccionada.observaciones">
              <span class="detail-icon">ğŸ“</span>
              <div class="detail-content">
                <span class="detail-label">Observaciones</span>
                <span class="detail-value">{{ seleccionada.observaciones }}</span>
              </div>
            </div>

            <div class="detail-item full-width" *ngIf="!seleccionada.observaciones">
              <span class="detail-icon">ğŸ“</span>
              <div class="detail-content">
                <span class="detail-label">Observaciones</span>
                <span class="detail-value no-data">Sin observaciones registradas</span>
              </div>
            </div>
          </div>
        </div>

        <!-- InformaciÃ³n de contacto (si estÃ¡ disponible) -->
        <div class="detail-section" *ngIf="seleccionada.estudiante?.email || seleccionada.estudiante?.telefono">
          <h4>InformaciÃ³n de Contacto</h4>
          <div class="detail-grid">
            <div class="detail-item full-width" *ngIf="seleccionada.estudiante?.email">
              <span class="detail-icon">ğŸ“§</span>
              <div class="detail-content">
                <span class="detail-label">Email</span>
                <span class="detail-value">{{ seleccionada.estudiante.email }}</span>
              </div>
            </div>

            <div class="detail-item full-width" *ngIf="seleccionada.estudiante?.telefono">
              <span class="detail-icon">ğŸ“±</span>
              <div class="detail-content">
                <span class="detail-label">TelÃ©fono</span>
                <span class="detail-value">{{ seleccionada.estudiante.telefono }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="cerrarDetalle()">
          Cerrar
        </button>
        <button class="btn-danger"
                *ngIf="puedeReagendar(seleccionada)"
                (click)="cancelarTutoria(seleccionada)">
          <span>ğŸš«</span>
          Cancelar TutorÃ­a
        </button>
        
        <button class="btn-primary"
                *ngIf="puedeReagendar(seleccionada)"
                (click)="reagendarTutoria(seleccionada)">
          <span>ğŸ”„</span>
          Reagendar
        </button>
      </div>
    </div>
  </div>
</div>
